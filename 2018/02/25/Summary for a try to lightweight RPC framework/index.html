<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"spground.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="1. RPCRPC即Remote Procedure Call（远程过程调用），直白的说就是：向调用本地服务一样调用远程计算机的服务。 由于现代应用日益复杂，单台机器显然不能满足需求。于是将业务按照一定的方式拆分开来，分散到多台机器上（或者一台机器上的多个进程），让每台机器各司其职，物尽其用。SOA和当前盛行的微服务便是从此变革历史中出现的产物。 为了达到各个分散在不同机器上的服务做到相互独立又相">
<meta property="og:type" content="article">
<meta property="og:title" content="初试轻量级RPC框架总结">
<meta property="og:url" content="https://spground.github.io/2018/02/25/Summary%20for%20a%20try%20to%20lightweight%20RPC%20framework/index.html">
<meta property="og:site_name" content="Spground Blog">
<meta property="og:description" content="1. RPCRPC即Remote Procedure Call（远程过程调用），直白的说就是：向调用本地服务一样调用远程计算机的服务。 由于现代应用日益复杂，单台机器显然不能满足需求。于是将业务按照一定的方式拆分开来，分散到多台机器上（或者一台机器上的多个进程），让每台机器各司其职，物尽其用。SOA和当前盛行的微服务便是从此变革历史中出现的产物。 为了达到各个分散在不同机器上的服务做到相互独立又相">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://static.oschina.net/uploads/space/2014/1229/002234_ENsM_223750.png">
<meta property="article:published_time" content="2018-02-24T16:00:00.000Z">
<meta property="article:modified_time" content="2025-09-24T14:30:21.568Z">
<meta property="article:author" content="Spground">
<meta property="article:tag" content="java">
<meta property="article:tag" content="rpc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://static.oschina.net/uploads/space/2014/1229/002234_ENsM_223750.png">


<link rel="canonical" href="https://spground.github.io/2018/02/25/Summary%20for%20a%20try%20to%20lightweight%20RPC%20framework/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://spground.github.io/2018/02/25/Summary%20for%20a%20try%20to%20lightweight%20RPC%20framework/","path":"2018/02/25/Summary for a try to lightweight RPC framework/","title":"初试轻量级RPC框架总结"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>初试轻量级RPC框架总结 | Spground Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Spground Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">77</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">11</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">41</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-RPC"><span class="nav-number">1.</span> <span class="nav-text">1. RPC</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E6%90%AD%E5%BB%BA%E8%BD%BB%E9%87%8F%E7%BA%A7RPC%E6%A1%86%E6%9E%B6"><span class="nav-number">2.</span> <span class="nav-text">2. 搭建轻量级RPC框架</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E7%BC%96%E5%86%99%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.1.</span> <span class="nav-text">第一步：编写服务接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E7%BC%96%E5%86%99%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="nav-number">2.2.</span> <span class="nav-text">第二步：编写服务接口的实现类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A-%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">2.3.</span> <span class="nav-text">第三步： 配置服务端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A-%E7%BC%96%E5%86%99%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="nav-number">2.4.</span> <span class="nav-text">第四步： 编写服务端代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A-%E7%BC%96%E5%86%99common%E7%B1%BB"><span class="nav-number">2.5.</span> <span class="nav-text">第五步： 编写common类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">2.6.</span> <span class="nav-text">第六步：配置客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%9A-%E7%BC%96%E5%86%99%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">2.7.</span> <span class="nav-text">第七步： 编写客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AB%E6%AD%A5%EF%BC%9A%E5%8F%91%E9%80%81RPC%E8%AF%B7%E6%B1%82"><span class="nav-number">2.8.</span> <span class="nav-text">第八步：发送RPC请求</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">3. 总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-Reference"><span class="nav-number">4.</span> <span class="nav-text">4. Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Spground</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">77</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://spground.github.io/2018/02/25/Summary%20for%20a%20try%20to%20lightweight%20RPC%20framework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Spground">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spground Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="初试轻量级RPC框架总结 | Spground Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          初试轻量级RPC框架总结
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-02-25 00:00:00" itemprop="dateCreated datePublished" datetime="2018-02-25T00:00:00+08:00">2018-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-24 22:30:21" itemprop="dateModified" datetime="2025-09-24T22:30:21+08:00">2025-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="1-RPC"><a href="#1-RPC" class="headerlink" title="1. RPC"></a>1. RPC</h1><p><code>RPC</code>即<code>Remote Procedure Call</code>（远程过程调用），直白的说就是：向调用本地服务一样调用远程计算机的服务。</p>
<p>由于现代应用日益复杂，单台机器显然不能满足需求。于是将业务按照一定的方式拆分开来，分散到多台机器上（或者一台机器上的多个进程），让每台机器各司其职，物尽其用。<code>SOA</code>和当前盛行的微服务便是从此变革历史中出现的产物。</p>
<p>为了达到各个分散在不同机器上的服务做到<strong>相互独立又相互联系</strong>，当计算机<code>A</code>上的服务<code>ServiceA</code>需要调用计算机<code>B</code>上的服务<code>ServiceB</code>时，需要一种互相遵守的<strong>协议</strong>来完成一次调用。</p>
<p>而这些协议便是<code>RPC</code>框架包含的内容。</p>
<p>以下从三个方面分析了高性能<code>RPC</code>的三个关键要素：</p>
<ul>
<li>传输协议</li>
</ul>
<blockquote>
<p><code>RPC</code> 可基于 <code>HTTP</code> 或 <code>TCP</code> 协议，<code>Web Service</code> 就是基于 <code>HTTP</code> 协议的 RPC，它具有良好的跨平台性，但其性能却不如基于 TCP 协议的 RPC。有两方面会直接影响 <code>RPC</code> 的性能，一是<strong>传输方式</strong>，二是<strong>序列化</strong>。</p>
</blockquote>
<ul>
<li>序列化方式</li>
</ul>
<blockquote>
<p>众所周知，TCP 是传输层协议，HTTP 是应用层协议，而传输层较应用层更加底层，在数据传输方面，越底层越快，因此，在一般情况下，TCP 一定比 HTTP 快。就序列化而言，Java 提供了默认的序列化方式，但在高并发的情况下，这种方式将会带来一些性能上的瓶颈，于是市面上出现了一系列优秀的序列化框架，比如：Protobuf、Kryo、Hessian、Jackson 等，它们可以取代 Java 默认的序列化，从而提供更高效的性能。</p>
</blockquote>
<ul>
<li>高并发（IO方式）</li>
</ul>
<blockquote>
<p>为了支持高并发，传统的阻塞式 IO 显然不太合适，因此我们需要异步的 IO，即 NIO。Java 提供了 NIO 的解决方案，Java 7 也提供了更优秀的 NIO.2 支持，用 Java 实现 NIO 并不是遥不可及的事情，只是需要我们熟悉 NIO 的技术细节。</p>
</blockquote>
<p>另外，服务部署在分布式环境下的不同节点，因此还需要提供一个服务注册与发现中心（Service Registry），让客户端发现可用的服务。应用、服务、注册表之间的关系如下图：</p>
<p><img src="http://static.oschina.net/uploads/space/2014/1229/002234_ENsM_223750.png"></p>
<p>考虑到上述的几个关键要素，做出如下选型：</p>
<ol>
<li>Spring : 业界权威的依赖注入框架</li>
<li>Netty: 封装了Java的NIO的一个网络框架</li>
<li>Protostuff: 基于Google的Protobuf的序列化框架，面向POJO，无需编写、编译.proto文件</li>
<li>Zookeeper: 分布式系统的必备选择，提供服务发现和服务注册功能</li>
</ol>
<p>参考了某篇博客，搭建一个基于TCP协议，采用Protostuff序列化方式，提供NIO支持且具备服务注册和发现的轻量级RPC框架。</p>
<h1 id="2-搭建轻量级RPC框架"><a href="#2-搭建轻量级RPC框架" class="headerlink" title="2. 搭建轻量级RPC框架"></a>2. 搭建轻量级RPC框架</h1><h2 id="第一步：编写服务接口"><a href="#第一步：编写服务接口" class="headerlink" title="第一步：编写服务接口"></a>第一步：编写服务接口</h2><p>没有规矩，不成方圆。制定客户端和服务端共同遵循的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IHelloService</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第二步：编写服务接口的实现类"><a href="#第二步：编写服务接口的实现类" class="headerlink" title="第二步：编写服务接口的实现类"></a>第二步：编写服务接口的实现类</h2><p>由于服务端提供服务，因此需要在服务端实现该接口，以便客户端后续通过RPC调用。</p>
<p>由于<strong>不同的服务是按照接口来区分</strong>的，而同一个服务实现类可以实现不同的接口（这些接口可能是服务接口或者其他接口），换句话说一个服务实现类可以提供多种不同的服务。</p>
<p>为了达到标示某个服务实现类对应哪个服务接口，需要自定义一个注解，然后通过<code>Spring</code>扫描包含该注解的<code>Bean</code>，这样就可以发现某个服务接口对应哪个服务实现类。</p>
<ol>
<li><p>自定义注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Component</span><span class="comment">// 表明可被Spring扫描</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RpcService &#123;</span><br><span class="line">	Class&lt;?&gt; value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
<li><p>编写服务实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RpcService(IHelloService.class)</span><span class="comment">//稍后通过Spring扫描</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldImpl</span> <span class="keyword">implements</span> <span class="title class_">IHelloService</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name + <span class="string">&quot; ==&gt; from remote greeting&quot;</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="第三步：-配置服务端"><a href="#第三步：-配置服务端" class="headerlink" title="第三步： 配置服务端"></a>第三步： 配置服务端</h2><ol>
<li>由于使用了Spring实现依赖注入，此处使用了<code>XML</code>方式声明<code>Bean</code>。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context/spring-context-3.0.xsd&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;dlut.rpc&quot;</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:rpc.properties&quot;</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- 配置服务发现组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;serviceRegistry&quot;</span> <span class="attr">class</span>=<span class="string">&quot;dlut.rpc.server.ZookeeperServiceRegistry&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;registryAddress&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;rpc.registry_address&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- 配置 RPC Server--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;rpcServer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;dlut.rpc.server.RpcServer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;serverAddress&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;rpc.server_address&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;serviceRegistry&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;serviceRegistry&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>服务端的Spring配置声明了如下内容：</p>
<ul>
<li>扫描路径</li>
<li>属性文件的路径</li>
<li>两个Bean，一个是ZookeeperServiceRegistry，另一个是RpcServer，且都通过构造器注入。</li>
</ul>
<ol start="2">
<li><p>编写rpc.properties配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpc.registry_address=127.0.0.1:2181</span><br><span class="line">rpc.server_address=127.0.0.1:8000</span><br></pre></td></tr></table></figure>

<p>主要是配置一些端口信息</p>
</li>
</ol>
<h2 id="第四步：-编写服务端代码"><a href="#第四步：-编写服务端代码" class="headerlink" title="第四步： 编写服务端代码"></a>第四步： 编写服务端代码</h2><p>由于RpcServer相当于是一个运行的入口，因此需要在所有Bean实例化后，做一些初始化的操作，这里RpcServer本来也是一个由Spring IoC容器管理的Bean（上面的服务器的Spring.xml配置中已经配置了）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServer</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span>, InitializingBean &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(RpcServer.class);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String serverAddress;</span><br><span class="line">	<span class="keyword">private</span> ZookeeperServiceRegistry serviceRegistry;<span class="comment">//由IoC自动注入</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, Object&gt; handlerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RpcServer</span><span class="params">(String serverAddress)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.serverAddress = serverAddress;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RpcServer</span><span class="params">(String serverAddress, ZookeeperServiceRegistry serviceRegistry)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">		<span class="built_in">this</span>.serverAddress = serverAddress;</span><br><span class="line">		<span class="built_in">this</span>.serviceRegistry = serviceRegistry;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext ctx)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		Map&lt;String, Object&gt; serviceBeanMap = ctx.getBeansWithAnnotation(RpcService.class);<span class="comment">//通过注解去发现提供rpc服务的Bean</span></span><br><span class="line">		<span class="keyword">if</span> (MapUtils.isNotEmpty(serviceBeanMap)) &#123;</span><br><span class="line">			<span class="keyword">for</span> (Object serviceBean : serviceBeanMap.values()) &#123;</span><br><span class="line">				<span class="type">String</span> <span class="variable">interfaceName</span> <span class="operator">=</span> serviceBean.getClass().getAnnotation(RpcService.class).value().getName();</span><br><span class="line">				handlerMap.put(interfaceName, serviceBean);<span class="comment">//建立服务接口--服务实现类的映射</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">		<span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">ServerBootstrap</span> <span class="variable">bootStrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">			<span class="comment">// 配置Server端的NIO</span></span><br><span class="line">			bootStrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</span><br><span class="line">					.childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">						<span class="meta">@Override</span></span><br><span class="line">						<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">							<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">							LOGGER.debug(<span class="string">&quot;initChannel&quot;</span>);</span><br><span class="line">							ch.pipeline()</span><br><span class="line">							.addLast(<span class="keyword">new</span> <span class="title class_">RpcDecoder</span>(RpcRequest.class))<span class="comment">// 处理Rpc请求 RpcRequest</span></span><br><span class="line">							.addLast(<span class="keyword">new</span> <span class="title class_">RpcEncoder</span>(RpcResponse.class))<span class="comment">// 处理Rpc RpcResponse</span></span><br><span class="line">							.addLast(<span class="keyword">new</span> <span class="title class_">RpcHandler</span>(handlerMap));<span class="comment">// 处理Rpc请求</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;)</span><br><span class="line">					.option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">					.option(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 解析地址</span></span><br><span class="line">			String[] array = serverAddress.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">			<span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">			<span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> Integer.parseInt(array[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">			<span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootStrap.bind(host, port).sync();</span><br><span class="line">			LOGGER.debug(<span class="string">&quot;server started on port &#123;&#125;&quot;</span>, port);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 注册服务</span></span><br><span class="line">			<span class="keyword">if</span> (serviceRegistry != <span class="literal">null</span>) &#123;</span><br><span class="line">				serviceRegistry.register(serverAddress);</span><br><span class="line">			&#125;</span><br><span class="line">			future.channel().closeFuture().sync();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			LOGGER.debug(<span class="string">&quot;worker group and boss group shutdown&quot;</span>);</span><br><span class="line">			workerGroup.shutdownGracefully();</span><br><span class="line">			bossGroup.shutdownGracefully();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>同时需要编写一个服务端的handler类（RpcServer当收到请求，并将其转换为RpcRequest后，RpcHandler将做进一步处理）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;RpcRequest&gt; &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(RpcHandler.class);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; handlerMap;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RpcHandler</span><span class="params">(Map&lt;String, Object&gt; handlerMap)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.handlerMap = handlerMap;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RpcRequest msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="type">RpcResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcResponse</span>();</span><br><span class="line">		response.setRequestId(msg.getRequestId());</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> handle(msg);</span><br><span class="line">			response.setResult(result);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			LOGGER.debug(<span class="string">&quot;handle ocurred error ==&gt; &#123;&#125;&quot;</span>, t);</span><br><span class="line">			response.setError(t);</span><br><span class="line">		&#125;</span><br><span class="line">		ctx.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);<span class="comment">//写完然后关闭channel</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Object <span class="title function_">handle</span><span class="params">(RpcRequest request)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> request.getClassName();<span class="comment">//此处极易出错，需要保证客户端和服务端的className是一致的，否则直接GG</span></span><br><span class="line">		<span class="type">Object</span> <span class="variable">serviceBean</span> <span class="operator">=</span> handlerMap.get(className);</span><br><span class="line">		<span class="keyword">if</span> (serviceBean == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Throwable</span>(String.format(<span class="string">&quot;can not find service bean by given name [%s] in server &quot;</span>, className));</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(handlerMap);</span><br><span class="line">		System.out.println(className);</span><br><span class="line">		Class&lt;?&gt; serviceClass = serviceBean.getClass();</span><br><span class="line">		<span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> request.getMethodName();</span><br><span class="line">		Class&lt;?&gt;[] parameterTypes = request.getParameterTypes();</span><br><span class="line">		Object[] parameters = request.getParameters();</span><br><span class="line">		LOGGER.debug(<span class="string">&quot;handle request &#123;&#125;&quot;</span>, request.getRequestId());</span><br><span class="line">		<span class="comment">//以下为利用CGlib反射调用serviceBean的方法</span></span><br><span class="line">		<span class="type">FastClass</span> <span class="variable">serviceFastClass</span> <span class="operator">=</span> FastClass.create(serviceClass);</span><br><span class="line">		<span class="type">FastMethod</span> <span class="variable">serviceFastMethod</span> <span class="operator">=</span> serviceFastClass.getMethod(methodName, parameterTypes);</span><br><span class="line">		<span class="keyword">return</span> serviceFastMethod.invoke(serviceBean, parameters);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		LOGGER.error(<span class="string">&quot;server caught exception&quot;</span>, cause);</span><br><span class="line">		ctx.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>最后需要编写一个引导类，用于加载Spring.xml文件启动Spring IoC容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcBootstrap</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;resource&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring.xml&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="第五步：-编写common类"><a href="#第五步：-编写common类" class="headerlink" title="第五步： 编写common类"></a>第五步： 编写common类</h2><p>第四步涉及到几个POJO封装类，由于这几个类无论是客户端还是服务端都是需要，因此应该单独将其打包作为公共的jar包。</p>
<ul>
<li>RpcRequest</li>
<li>RpcResponse</li>
<li>RpcEncoder</li>
<li>RpcDecoder</li>
<li>SerializationUtil</li>
<li>Constants</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcRequest</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> String requestId;</span><br><span class="line">	<span class="keyword">private</span> String className;</span><br><span class="line">	<span class="keyword">private</span> String methodName;</span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt;[] parameterTypes;</span><br><span class="line">	<span class="keyword">private</span> Object[] parameters;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getRequestId</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> requestId;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRequestId</span><span class="params">(String requestId)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.requestId = requestId;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getClassName</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> className;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setClassName</span><span class="params">(String className)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.className = className;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getMethodName</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> methodName;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMethodName</span><span class="params">(String methodName)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.methodName = methodName;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> Class&lt;?&gt;[] getParameterTypes() &#123;</span><br><span class="line">		<span class="keyword">return</span> parameterTypes;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParameterTypes</span><span class="params">(Class&lt;?&gt;[] parameterTypes)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.parameterTypes = parameterTypes;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> Object[] getParameters() &#123;</span><br><span class="line">		<span class="keyword">return</span> parameters;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParameters</span><span class="params">(Object[] parameters)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.parameters = parameters;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcResponse</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> String requestId;</span><br><span class="line">	<span class="keyword">private</span> Throwable error;</span><br><span class="line">	<span class="keyword">private</span> Object result;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getRequestId</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> requestId;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRequestId</span><span class="params">(String requestId)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.requestId = requestId;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> Throwable <span class="title function_">getError</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> error;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setError</span><span class="params">(Throwable error)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.error = error;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">getResult</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResult</span><span class="params">(Object result)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.result = result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;[id: &quot;</span> + requestId + <span class="string">&quot;, result: &quot;</span> + result + <span class="string">&quot;, error: &quot;</span> + error +  <span class="string">&quot;]&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToByteEncoder</span>&lt;RpcResponse&gt; &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(RpcEncoder.class);</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, RpcResponse msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="type">byte</span>[] data = SerializationUtil.serialize(msg);</span><br><span class="line">		LOGGER.debug(<span class="string">&quot;encode =&gt; datalength =&gt; &#123;&#125;&quot;</span>, data.length);</span><br><span class="line">		out.writeInt(data.length);</span><br><span class="line">		out.writeBytes(data);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcDecoder</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageDecoder</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(RpcDecoder.class);</span><br><span class="line">	<span class="keyword">private</span> Class&lt;?&gt; genericClass;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RpcDecoder</span><span class="params">(Class&lt;?&gt; genericClass)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">		<span class="built_in">this</span>.genericClass = genericClass;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		LOGGER.debug(<span class="string">&quot;decode =&gt; datalength =&gt; &#123;&#125;&quot;</span>, in.readableBytes());</span><br><span class="line">		<span class="comment">//按照自己的协议，进行解析；</span></span><br><span class="line">		<span class="comment">//dataLength|dataContent</span></span><br><span class="line">		<span class="keyword">if</span> (in.readableBytes() &lt; <span class="number">4</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		in.markReaderIndex();</span><br><span class="line">		<span class="type">int</span> <span class="variable">dataLength</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">		<span class="keyword">if</span> (dataLength &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			ctx.close();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (in.readableBytes() &lt; dataLength) &#123;<span class="comment">//数据还未完全接受完毕，重置in的read Index；等待下一次decode；；</span></span><br><span class="line">			in.resetReaderIndex();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[dataLength];</span><br><span class="line">		in.readBytes(data);</span><br><span class="line">		<span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> SerializationUtil.deserialize(data, <span class="built_in">this</span>.genericClass);<span class="comment">//反序列化</span></span><br><span class="line">		LOGGER.debug(<span class="string">&quot;decode =&gt; deserialize ok&quot;</span>);</span><br><span class="line">		out.add(obj);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializationUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, Schema&lt;?&gt;&gt; cachedSchema = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ObjenesisStd</span> <span class="variable">objenesis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjenesisStd</span>(<span class="literal">true</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="title function_">SerializationUtil</span><span class="params">()</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; Schema&lt;T&gt; <span class="title function_">getSchema</span><span class="params">(Class&lt;T&gt; cls)</span> &#123;</span><br><span class="line">		Schema&lt;T&gt; schema = (Schema&lt;T&gt;) cachedSchema.get(cls);</span><br><span class="line">		<span class="keyword">if</span> (schema == <span class="literal">null</span>) &#123;</span><br><span class="line">			schema = RuntimeSchema.createFrom(cls);</span><br><span class="line">			<span class="keyword">if</span> (schema != <span class="literal">null</span>) &#123;</span><br><span class="line">				cachedSchema.put(cls, schema);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> schema;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] data, Class&lt;T&gt; cls)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">T</span> <span class="variable">msg</span> <span class="operator">=</span> objenesis.newInstance(cls);</span><br><span class="line">			Schema&lt;T&gt; schema = getSchema(cls);</span><br><span class="line">			ProtostuffIOUtil.mergeFrom(data,msg, schema);</span><br><span class="line">			<span class="keyword">return</span> msg;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e.getMessage(), e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T msg) &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		Class&lt;T&gt; cls = (Class&lt;T&gt;) msg.getClass();</span><br><span class="line">		<span class="type">LinkedBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> LinkedBuffer.allocate(LinkedBuffer.DEFAULT_BUFFER_SIZE);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Schema&lt;T&gt; schema = getSchema(cls);</span><br><span class="line">			<span class="keyword">return</span> ProtostuffIOUtil.toByteArray(msg, schema, buffer);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e.getMessage(), e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			buffer.clear();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Constant</span> &#123;</span><br><span class="line">	 <span class="type">int</span> <span class="variable">ZK_SESSION_TIMEOUT</span> <span class="operator">=</span> <span class="number">5000</span>;</span><br><span class="line">	 <span class="type">String</span> <span class="variable">ZK_REGISTRY_PATH</span> <span class="operator">=</span> <span class="string">&quot;/registry&quot;</span>;</span><br><span class="line">	 <span class="type">String</span> <span class="variable">ZK_DATA_PATH</span> <span class="operator">=</span> ZK_REGISTRY_PATH + <span class="string">&quot;/data&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此服务端代码编写完毕，接下来编写客户端代码。</p>
<h2 id="第六步：配置客户端"><a href="#第六步：配置客户端" class="headerlink" title="第六步：配置客户端"></a>第六步：配置客户端</h2><p>和配置服务端一样，也是对客户端的Spring.xml进行配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context/spring-context-3.0.xsd&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;dlut.rpc-client&quot;</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:rpc-client.properties&quot;</span>/&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- 配置服务发现组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;serviceDiscover&quot;</span> <span class="attr">class</span>=<span class="string">&quot;dlut.rpc_client.ServiceDiscover&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;registryAddress&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;rpc.registry_address&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">&lt;!-- 配置 RPC 代理 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;rpcProxy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;dlut.rpc_client.RpcProxy&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;serviceDiscover&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;serviceDiscover&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写配置文件<code>rpc-client.properties</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpc.registry_address=127.0.0.1:2181</span><br></pre></td></tr></table></figure>

<h2 id="第七步：-编写客户端"><a href="#第七步：-编写客户端" class="headerlink" title="第七步： 编写客户端"></a>第七步： 编写客户端</h2><ul>
<li><p>编写RpcClient类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcClient</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;RpcResponse&gt; &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(RpcClient.class);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> RpcResponse response;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RpcClient</span><span class="params">(String host, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">		<span class="built_in">this</span>.host = host;</span><br><span class="line">		<span class="built_in">this</span>.port = port;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RpcResponse msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="built_in">this</span>.response = msg;</span><br><span class="line">		LOGGER.debug(<span class="string">&quot;receive msg from &quot;</span>);</span><br><span class="line">		LOGGER.debug(<span class="string">&quot;content =&gt; &#123;&#125;&quot;</span>, <span class="built_in">this</span>.response);</span><br><span class="line">		<span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">			lock.notifyAll();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> RpcResponse <span class="title function_">send</span><span class="params">(RpcRequest request)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">			bootstrap.group(group)</span><br><span class="line">			.channel(NioSocketChannel.class)</span><br><span class="line">			.handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">					<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">					ch.pipeline()</span><br><span class="line">					.addLast(<span class="keyword">new</span> <span class="title class_">RpcEncoder</span>(RpcRequest.class)) <span class="comment">//编码请求</span></span><br><span class="line">					.addLast(<span class="keyword">new</span> <span class="title class_">RpcDecoder</span>(RpcResponse.class))<span class="comment">//解码回复</span></span><br><span class="line">					.addLast(RpcClient.<span class="built_in">this</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125;)</span><br><span class="line">			.option(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>);</span><br><span class="line">			LOGGER.debug(<span class="string">&quot;host =&gt; &#123;&#125;, port =&gt; &#123;&#125;&quot;</span>, host, port);</span><br><span class="line">			<span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(host, port).sync();</span><br><span class="line">			future.channel().writeAndFlush(request).sync();</span><br><span class="line">			</span><br><span class="line">			LOGGER.debug(<span class="string">&quot;connected&quot;</span>);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">synchronized</span> (lock ) &#123;</span><br><span class="line">				lock.wait();<span class="comment">//阻塞直到消息被RpcResponse被读取到</span></span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (response != <span class="literal">null</span>) &#123;</span><br><span class="line">				future.channel().closeFuture().sync();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> response;</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			group.shutdownGracefully();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		LOGGER.error(<span class="string">&quot;client caught exception&quot;</span>, cause);</span><br><span class="line">        ctx.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
<li><p>编写RpcProxy类，用于生成对RPC服务接口的代理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcProxy</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> String serverAddress;</span><br><span class="line">	<span class="keyword">private</span> ServiceDiscover serviceDiscover;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RpcProxy</span><span class="params">(ServiceDiscover serviceDiscover)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.serviceDiscover = serviceDiscover;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">RpcProxy</span><span class="params">(String serverAddress)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.serverAddress = serverAddress;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; T <span class="title function_">create</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (T) Proxy.newProxyInstance(</span><br><span class="line">				interfaceClass.getClassLoader(),</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;interfaceClass&#125;,</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">					</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">						<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">						<span class="comment">//封装请求</span></span><br><span class="line">						<span class="type">RpcRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcRequest</span>();</span><br><span class="line">						request.setRequestId(UUID.randomUUID().toString());</span><br><span class="line">						request.setClassName(method.getDeclaringClass().getName());</span><br><span class="line">						request.setMethodName(method.getName());</span><br><span class="line">						request.setParameterTypes(method.getParameterTypes());</span><br><span class="line">						request.setParameters(args);</span><br><span class="line">						</span><br><span class="line">						<span class="keyword">if</span> (serviceDiscover != <span class="literal">null</span>) &#123;</span><br><span class="line">							serverAddress = serviceDiscover.discover();</span><br><span class="line">						&#125; </span><br><span class="line">						</span><br><span class="line">						String[] array = serverAddress.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">						<span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">						<span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> Integer.parseInt(array[<span class="number">1</span>]);</span><br><span class="line">						</span><br><span class="line">						<span class="type">RpcClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcClient</span>(host, port);</span><br><span class="line">						<span class="type">RpcResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.send(request);<span class="comment">//阻塞直到方法返回</span></span><br><span class="line">						<span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> response.getResult();</span><br><span class="line">						</span><br><span class="line">						System.out.println(Arrays.toString(obj.getClass().getTypeParameters()));</span><br><span class="line">						</span><br><span class="line">						<span class="keyword">if</span> (response == <span class="literal">null</span>)</span><br><span class="line">							<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;response is null&quot;</span>);</span><br><span class="line">						<span class="keyword">if</span> (response.getError() != <span class="literal">null</span>) &#123;</span><br><span class="line">							<span class="keyword">throw</span> response.getError();</span><br><span class="line">						&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">							<span class="keyword">return</span> response.getResult();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
<li><p>编写服务发现ServiceDiscover类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceDiscover</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(ServiceDiscover.class);</span><br><span class="line">	<span class="keyword">private</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;String&gt; dataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> String registryAddress;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">ServiceDiscover</span><span class="params">(String registryAddress)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.registryAddress = registryAddress;</span><br><span class="line">		<span class="type">ZooKeeper</span> <span class="variable">zk</span> <span class="operator">=</span> connectServer();</span><br><span class="line">		<span class="keyword">if</span> (zk != <span class="literal">null</span>) &#123;</span><br><span class="line">			watchNode(zk);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">discover</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> dataList.size();</span><br><span class="line">		<span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (size == <span class="number">1</span>) &#123;</span><br><span class="line">				data = dataList.get(<span class="number">0</span>);</span><br><span class="line">				LOGGER.debug(<span class="string">&quot;using only data: &#123;&#125;&quot;</span>, data);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				data = dataList.get(ThreadLocalRandom.current().nextInt(size));</span><br><span class="line">				LOGGER.debug(<span class="string">&quot;using random data: &#123;&#125;&quot;</span>, data);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> data;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//查看所有结点</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">watchNode</span><span class="params">(<span class="keyword">final</span> ZooKeeper zk)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			List&lt;String&gt; nodeList = zk.getChildren(Constant.ZK_REGISTRY_PATH, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">					<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">					<span class="keyword">if</span> (event.getType() == Event.EventType.NodeChildrenChanged) &#123;</span><br><span class="line">						watchNode(zk);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">			List&lt;String&gt; dataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">			<span class="keyword">for</span> (String node : nodeList ) &#123;</span><br><span class="line">				<span class="type">byte</span>[] bytes = zk.getData(Constant.ZK_REGISTRY_PATH + <span class="string">&quot;/&quot;</span> + node, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">				dataList.add(<span class="keyword">new</span> <span class="title class_">String</span>(bytes));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">this</span>.dataList = dataList;</span><br><span class="line">			LOGGER.debug(<span class="string">&quot;node data: &#123;&#125;&quot;</span>, dataList);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (KeeperException | InterruptedException e) &#123;</span><br><span class="line">			LOGGER.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接到zookeeper</span></span><br><span class="line">	<span class="keyword">private</span> ZooKeeper <span class="title function_">connectServer</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		 <span class="type">ZooKeeper</span> <span class="variable">zk</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	        <span class="keyword">try</span> &#123;</span><br><span class="line">	            zk = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(registryAddress, Constant.ZK_SESSION_TIMEOUT, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">	                <span class="meta">@Override</span></span><br><span class="line">	                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">	                    <span class="keyword">if</span> (event.getState() == Event.KeeperState.SyncConnected) &#123;</span><br><span class="line">	                        latch.countDown();</span><br><span class="line">	                    &#125;</span><br><span class="line">	                &#125;</span><br><span class="line">	            &#125;);</span><br><span class="line">	            latch.await();</span><br><span class="line">	        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">	            LOGGER.error(<span class="string">&quot;&quot;</span>, e);</span><br><span class="line">	        &#125;</span><br><span class="line">	        <span class="keyword">return</span> zk;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第八步：发送RPC请求"><a href="#第八步：发送RPC请求" class="headerlink" title="第八步：发送RPC请求"></a>第八步：发送RPC请求</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;resource&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> &#123;</span><br><span class="line">    	<span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-client.xml&quot;</span>);</span><br><span class="line">    	</span><br><span class="line">    	<span class="type">RpcProxy</span> <span class="variable">rpcProxy</span> <span class="operator">=</span> context.getBean(RpcProxy.class);</span><br><span class="line">        </span><br><span class="line">    	<span class="type">IHelloService</span> <span class="variable">helloService</span> <span class="operator">=</span> rpcProxy.create(IHelloService.class);</span><br><span class="line">        </span><br><span class="line">    	<span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> helloService.hello(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    	System.out.println(result);</span><br><span class="line">        </span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
</ul>
<h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h1><p>参照网络上的一篇博客，自己照猫画虎搭建了一个轻量级RPC框架，了解学习了一些常听说的工具（例如Netty、Zookeeper）等在RPC框架中的应用场景。</p>
<p>搭建该框架的时候，使用Spring作为依赖注入框架，Netty实现NIO方式的数据传输、使用了高效的Protostuff对象序列化工具以及使用了Zookeeper作为分布式环境下的服务发现和服务注册。</p>
<p>具体来梳理下整个框架的运行逻辑。</p>
<ol>
<li><p>启动RpcServer</p>
<p>1.1 通过运行RpcBootstap类，加载了服务器端的spring.xml并启动了IoC容器，随后将xml文件中声明的Bean都实例化；</p>
<p>1.2 扫描带有RpcService注解的类，建立服务接口—服务实现类的映射</p>
<p>1.3 执行RpcServer的初始化操作，包括连接到Zookeeper服务进行服务注册，启动Netty NIO的事件轮询线程池和工作线程池等</p>
</li>
<li><p>客户端App类的运行</p>
<p>2.1 加载客户端配置的spring.xml并启动IoC容器将声明的Bean实例化</p>
<p>2.2 调用RpcProxy的create方法获取服务接口IHelloService的代理类</p>
<p>2.3 执行代理类的hello方法，代理类将请求封装成RpcRequest类，然后连接到Zookeeper服务进行服务发现获取主机地址和端口号，然后调用RpcClient发送请求，获取结果。</p>
<p>2.4 RpcClient配置并启动一个Netty EventLoopGroup，将封装的RpcRuest请求发送出去；</p>
<p>2.5 RpcRequest经由RpcEncoder序列化为二进制数据，然后经由TCP协议发送出去；</p>
<p>2.6 客户端收到来自服务端的二进制数据响应，然后通过RpcDecoder反序列化为RpcResponse类</p>
</li>
<li><p>服务器端接受到该RpcRequest的二进制数据，经由RpcDecoder反序列为RpcRequest类，然后通过服务接口—服务实现类映射表查找到对应的实现类Bean，再通过反射调用对应的方法，获取到结果；然后封装成RpcResponse类，随即被RpcEncoder序列化为二进制数据，并交由netty通过TCP协议发送到客户端；</p>
</li>
</ol>
<p>详细代码参见：<a href="https://github.com/Spground/RpcDemo">https://github.com/Spground/RpcDemo</a></p>
<h1 id="4-Reference"><a href="#4-Reference" class="headerlink" title="4. Reference"></a>4. Reference</h1><p><a href="https://my.oschina.net/huangyong/blog/361751?p=2&temp=1519544796844#blog-comments-list">https://my.oschina.net/huangyong/blog/361751?p=2&amp;temp=1519544796844#blog-comments-list</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/rpc/" rel="tag"># rpc</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/02/03/java%20lock/" rel="prev" title="Java并发中的锁">
                  <i class="fa fa-angle-left"></i> Java并发中的锁
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2018/10/15/docker-guide-01-Orientation/" rel="next" title="1. Orientation">
                  1. Orientation <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Spground</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
